# MIP-20260228: Universal Memory Indexing Plan (Moon-Lancedb)

## üéØ Objective
Establish a high-fidelity, permanent vector index for all historical and active memory files (`memory/*.md`) to enable semantic recall across all Lilac sessions.

## üèóÔ∏è Architecture: Hybrid Vector + BM25
We will utilize the **LanceDB** backend (via the `moon` plugin/system) to store embeddings. This allows for rapid similarity search alongside structured metadata filtering.

### 1. Data Sources
- **Primary**: `memory/*.md` (Daily logs and distilled insights).
- **Secondary**: `archives/mlib/*.md` (Projections of past raw sessions).
- **Static**: `MEMORY.md`, `USER.md`, `IDENTITY.md`.

### 2. Implementation Strategy

#### Phase A: Embedding Pipeline
- **Model**: `text-embedding-3-small` (or `3-large` for maximum signal).
- **Chunking**: Semantic paragraph-based chunking with 15% overlap.
- **Metadata**: 
    - `file_path`: Absolute path to source.
    - `date`: Extracted from filename or frontmatter.
    - `checksum`: SHA-256 for change detection.
    - `category`: (e.g., `daily-log`, `distillation`, `system-config`).

#### Phase B: Automated Sync (The "Moon Watcher")
- Extend `moon-watch` to monitor the `memory/` directory.
- Trigger incremental re-indexing on file save/rename.
- Periodic "Deep Sweep" every 24 hours to ensure index integrity.

#### Phase C: Recall Interface
- Integrate with `moon-recall`.
- Support query expansion (e.g., "Find all mentions of Venus System logic in late February").

## ‚öôÔ∏è Unified Configuration Design (The .toml Standard)

To eliminate configuration fragmentation, the `.env` file is being deprecated. `moon.toml` will serve as the **single source of truth** for all user-defined settings.

### 1. Precedence & Defaults
- **Primary Source**: `moon.toml` (All user configurations).
- **Fallback**: Built-in system defaults (Hardcoded in `config.rs` to ensure operational stability if `moon.toml` is missing or incomplete).
- **Runtime Overrides**: Standard environment variables (e.g., `MOON_WATCH_INTERVAL`) remain supported for temporary overrides during debugging or CI/CD.

### 2. Implementation Strategy
- **Total Migration**: All secrets, API keys, and machine-specific binary paths previously stored in `.env` must be moved into structured `[sections]` within `moon.toml`.
- **Zero-Config Ready**: The system must be able to boot and perform basic operations using background defaults if no `moon.toml` is provided.
- **Strict Validation**: The `moon verify` command will now exclusively check `moon.toml` for structural integrity and required keys.

## üõ°Ô∏è Operational Safety (Preventing Malpractice)

The `moon` system's current CLI is optimized for performance but sensitive to environmental misuse. To prevent agents (and Master) from accidentally destabilizing the daemon, we implement the following safety protocols:

### 1. Code-Consistency Enforcement
- **The Risk**: Agents attempting to hot-load settings when the underlying logic in `src/` has changed significantly without a rebuild.
- **The Protocol**: The daemon will now embed a **Build UUID** (generated at compile-time).
- **Enforcement**: Any CLI interaction must verify its binary hash against the running PID's hash. If they mismatch, the CLI will refuse to send "Reload" signals and instead prompt for a `moon restart --rebuild`.

### 2. Context-Aware Execution (Working Dir Lock)
- **The Risk**: Running `moon` commands from a sibling directory or a detached shell, causing the daemon to look for `moon.toml` or `lancedb/` in the wrong relative path.
- **The Protocol**: Absolute path anchoring. On first boot, the daemon records the absolute path of its `MOON_HOME`.
- **Enforcement**: Every command now performs a `cwd` validation. If the agent is not in the authorized workspace root, the command fails with `ERR_OUT_OF_BOUNDS`.

### 3. PID & Lockfile Integrity
- **The Risk**: Manual deletion of `.lock` files or rapid-fire start/stop commands creating "Zombie" processes with overlapping PIDs in the lockfile.
- **The Protocol**: **Liveness Verification**.
- **Enforcement**: 
    - The `.lock` file must contain the PID *and* the start-timestamp.
    - When `moon start` is called, the CLI must perform a `kill(0, pid)` check to see if the process is actually alive. 
    - If the PID exists but the Build UUID is different, it will treat the lock as stale and automatically remediate it rather than hanging.

## üõ†Ô∏è Action Items (Today)
1. [ ] Configure `moon` plugin to include `memory/` in its `watched_paths`.
2. [ ] Initialize the `lancedb` table `memory_index`.
3. [ ] Run initial batch ingestion of existing `memory/*.md` files.
4. [ ] Verify recall accuracy with a test query.

## üìä Resource Allocation
- **Disk Space**: Unrestricted (High-precision vectors).
- **Compute**: Background prioritization via `moon-watch` daemon.
- **Provider**: OpenAI Embedding API.

---
*Created by Lilac Livint | Master's Maid*
